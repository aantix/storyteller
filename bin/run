#!/usr/bin/env ruby
# adapted from ruby-aws gem's sample code

require "pp"
require_relative "../lib/init"
require 'amazon/webservices/mturk/question_generator'
require "highline/import"

PREAMBLE = '<?xml version="1.0" encoding="UTF-8"?>'+"\n"
PREAMBLE << '<QuestionForm xmlns="http://mechanicalturk.amazonaws.com/AWSMechanicalTurkDataSchemas/2005-10-01/QuestionForm.xsd">' + "\n"
TAIL = '</QuestionForm>'

def create_question(sentence_num,story)
  paragraphs = story.split(/\n+/)

  components = [PREAMBLE]

  components << <<-QUESTION
  <Question>
    <QuestionIdentifier>StorySentence#{sentence_num}</QuestionIdentifier>
    <IsRequired>true</IsRequired>
    <QuestionContent>
      <Title>Add one complete sentence to the following story:</Title>
      #{paragraphs.map { |p| "<Text>#{p}</Text>" }.join("\n") }
      <Title>Please keep the following guidelines in mind:</Title>
      <List>
        <ListItem>You must write a complete sentence that makes logical sense in the context of the story.</ListItem>
        <ListItem>Write the first sentence that comes to mind.</ListItem>
        <ListItem>Do not copy the sentence from another source.</ListItem>
        <ListItem>Begin with a asterisk character (*) if you would like to start a new paragraph.</ListItem>
      </List>
    </QuestionContent>
    <AnswerSpecification>
      <FreeTextAnswer>
        <NumberOfLinesSuggestion>2</NumberOfLinesSuggestion>
      </FreeTextAnswer>
    </AnswerSpecification>
  </Question>
  QUESTION

  components << TAIL
  components.join
end

# These sentences were generated by a previous mechanical turk job
OPENING_SENTENCES = [
   "Jim approached the open door cautiously, unsure of the source of noise he had heard just moments prior.",
   "It was midnight, she was driving back home after a long day at work still thinking of the stranger that had spoken to her in the street.",
   "Yesterday was the best day of my whole life.",
   "Today would be the third day Sarah and her younger brother had been on the road alone after running away from the orphanage.",
   "Once upon a time, lived a little elf named snowball, who worked for Santa at the North Pole.",
   "Hurriedly, she pushed the email icon on her phone to read the message from Sandy, the drug counselor.",
   "There was something off about the way he watched her, his eyes never broke away - even after she had crossed the street.",
   "\"Well, everything went better than expected\", Andy thought as he left the building with the business card still in his hand.",
   "A lump rose in Andy's throat and he brushed away tears as he reread the chilling message taped to his dorm room door.",
   "There was a funny little house in the town, that had stood vacant for many years.",
   "It was a dark rainy night in November as Marcus felt a cold wind blow down Hanging Dog Creek.",
   "It was the height of summer, it was warm and sunny and beautiful outside but Cooper didn't feel in any way excited as he sat at his kitchen table, sipping his by now luke warm morning coffee, trying to make sense of what had happened the night before.",
   "I was a big, fast, tailback with a nasty streak and a taste for blood.",
   "The old woman turned and smiled."
]

# these are the sentences that were added by mechanical turk workers while testing this script.

story = <<-STORY
A lump rose in Andy's throat and he brushed away tears as he reread the chilling message taped to his dorm room door. This can't be happening he thought, How could someone do this to me? Andy carefully took the note off of the door, and entered his room. He sat at the edge of his bed, thoughts racing through his head as he stared at the paper in his hand. He tore it furiously.
His girlfriend left him. She was never happy in the relationship and decided against continuing it. He was at a loss at what to think or say or do.  She was his first girlfriend, his first love. Andy decided to talk to his girlfriend and see if there was anything that could be done to save their relationship. He ran as fast as he could, almost tripping down the stairs, as he held back tears, to her dorm room three flights below his. When he got there, he stopped for a while and took a deep breath. He entered without knocking the door. Something was amiss - his girlfriend's dorm room looked like it had been ransacked, and she was nowhere to be found. As he backed slowly out of the room, he bumped into his girlfriends roommate Ella, who shoved him and said stearnly "Why are you in here?  Don't you know, Alexis broke up with you!" Andy looked at her with empty eyes, pushed her aside and run away. He was starting to suspect that someone had kidnapped his girlfriend and left him a fake break-up note so that he would stay away and not become suspicious - and maybe her friend Ella knew something. He had to go back. But before that he needed to take a closer look at the note to make sure that it was not Ella's handwriting. He entered his room and took carefully the pieces of the note from the floor. He put them together. He was really confused, it was her handwriting. He felt so devastated that he couldn't even cry.
A sense of calm came over Andy as he reached for the phone to call the police. "Someone is bleeding to death in the basement" he stated. "Are they still conscious?" Asked the officer. "Barely so.", he replied, "Her breathing is faltering."
"What is your address?" the voice asked, calm and collected. Andy, aware of the address belonging to a large dormitory, calmly stated the address, spelling out the street name with perfect enunciation.
STORY

options = {
  AWSAccessKeyId: ENV['AWS_ACCESS_KEY_ID'],
  AWSAccessKey: ENV['AWS_ACCESS_KEY'],
  Host: ENV['PRODUCTION'] == "true" ? "Prod" : "Sandbox"
}

mturk = Amazon::WebServices::MechanicalTurkRequester.new(options)

25.times do |num|
  question = create_question(num,story)

  begin
    result = mturk.createHIT(:Title => "Write one sentence in a short fiction story",
                             :Description => "Use your imagination to contribute one complete sentence to a short fictional story written by Mechanical Turk authors, one line at a time.",
                             :MaxAssignments => 1,
                             :Reward => { :Amount => 0.10, :CurrencyCode => 'USD' },
                             :Question => question,
                             :Keywords => "writing, content, creation, fiction, fun, easy, fast")
  rescue StandardError => e
    fail e.to_s
  end

  hit_id = result[:HITId]

  puts "Created HIT: #{hit_id}"

  if mturk.host =~ /sandbox/
    puts "http://workersandbox.mturk.com/mturk/preview?groupId=#{result[:HITTypeId]}"
  else
    puts "http://mturk.com/mturk/preview?groupId=#{result[:HITTypeId]}"
  end

  loop do
    result = mturk.getHITResults([{ HITId: hit_id }])

    if result.any?
      result = result.first
      answer = result[:Answer]
      sentence = mturk.simplifyAnswer(answer).values.first.strip
      notice = "Received result: \"#{sentence}\""
      puts notice
      `growlnotify -m #{notice}`

      if agree("Accept this sentence? (y/n)")
        sentence.gsub!(/\*/,"\n\n")
        story += " " + sentence
        mturk.approveAssignment(AssignmentId: result[:AssignmentId], RequesterFeedback: "Well Done!")
        puts "The story so far:\n\n#{story}"
      else
        puts "Rejecting this sentence"
        mturk.rejectAssignment(AssignmentId: result[:AssignmentId])
      end

      break
    else
      puts "No result yet..."
      sleep(30)
    end
  end
end


# Example response from getHITResults:
#
#[{:Request=>{:IsValid=>"True"},
  #:HITId=>"26XE4EGDHDM268HOYVQWDHEZ65RBLM",
  #:HITTypeId=>"29P6NG1FS3NYO6K4496ZZZL2XRIZLY",
  #:CreationTime=>2011-12-02 21:59:10 UTC,
  #:Title=>"Write one sentence in a short fiction story",
  #:Description=>
   #"Use your imagination to contribute one complete sentence to a short fictional story written by Mechanical Turk authors, one line at a time.",
  #:Question=>
   #"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<QuestionForm xmlns=\"http://mechanicalturk.amazonaws.com/AWSMechanicalTurkDataSchemas/2005-10-01/QuestionForm.xsd\">\n  <Question>\n    <QuestionIdentifier>StorySentence0</QuestionIdentifier>\n    <IsRequired>true</IsRequired>\n    <QuestionContent>\n      <Title>Add one complete sentence to the following story:</Title>\n      <List>\n        <ListItem>You must write a complete sentence that makes logical sense in the context of the story.</ListItem>\n        <ListItem>Write the first sentence that comes to mind.</ListItem>\n        <ListItem>Do not copy the sentence from another source.</ListItem>\n        <ListItem>Type an asterisk character (*) if you would like to start a new paragraph.</ListItem>\n      </List>\n      <Text>A lump rose in Andy's throat and he brushed away tears as he reread the chilling message taped to his dorm room door.</Text>\n    </QuestionContent>\n    <AnswerSpecification>\n      <FreeTextAnswer>\n        <NumberOfLinesSuggestion>2</NumberOfLinesSuggestion>\n      </FreeTextAnswer>\n    </AnswerSpecification>\n  </Question>\n</QuestionForm>",
  #:Keywords=>"writing, content, creation, fiction, fun",
  #:HITStatus=>"Reviewable",
  #:MaxAssignments=>1,
  #:Reward=>{:Amount=>0.15, :CurrencyCode=>"USD", :FormattedPrice=>"$0.15"},
  #:AutoApprovalDelayInSeconds=>604800,
  #:Expiration=>2011-12-03 21:59:10 UTC,
  #:AssignmentDurationInSeconds=>3600,
  #:NumberOfSimilarHITs=>0,
  #:HITReviewStatus=>"NotReviewed",
  #:NumberOfAssignmentsPending=>0,
  #:NumberOfAssignmentsAvailable=>0,
  #:NumberOfAssignmentsCompleted=>0,
  #:AssignmentId=>"2OKCWY2AOO2GN9NMDW7QZCM6I9A33S",
  #:WorkerId=>"A25L94D9I3GJFQ",
  #:AssignmentStatus=>"Submitted",
  #:Answer=>
   #"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<QuestionFormAnswers xmlns=\"http://mechanicalturk.amazonaws.com/AWSMechanicalTurkDataSchemas/2005-10-01/QuestionFormAnswers.xsd\">\n<Answer>\n<QuestionIdentifier>StorySentence0</QuestionIdentifier>\n<FreeText>This can't be happening he thought, How could someone do this to me? Andy carefully took the note off of the door, and entered his room.</FreeText>\n</Answer>\n</QuestionFormAnswers>\n"}]

   #hit_id = "26XE4EGDHDM268HOYVQWDHEZ65RBLM"
