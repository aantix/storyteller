#!/usr/bin/envy ruby
# adapted from ruby-aws sample code

require_relative "../lib/init"
require 'amazon/webservices/mturk/question_generator'
include Amazon::WebServices::MTurk

options = {
  AWSAccessKeyId: ENV['AWS_ACCESS_KEY_ID'],
  AWSAccessKey: ENV['AWS_ACCESS_KEY'],
  Host: Sandbox
}

mturk = Amazon::WebServices::MechanicalTurkRequester.new(options)

PREAMBLE = '<?xml version="1.0" encoding="UTF-8"?>'+"\n"+'<QuestionForm xmlns="http://mechanicalturk.amazonaws.com/AWSMechanicalTurkDataSchemas/2005-10-01/QuestionForm.xsd">'
TAIL = '</QuestionForm>'

def create_question(sentence_num,story)
  paragraphs = story.split(/\n/)

  components = [PREAMBLE]
  components <<-QUESTION
  <Question>
    <QuestionIdentifier>StorySentence#{sentence_num}</QuestionIdentifier>
    <IsRequired>true</IsRequired>
    <QuestionContent>
      <Title>Add one complete sentence to the following story:</Title>
      <List>
        <ListItem>You must write a complete sentence that makes logical sense in the context of the story.</ListItem>
        <ListItem>Write the first sentence that comes to mind.</ListItem>
        <ListItem>Do not copy the sentence from another source.</ListItem>
        <ListItem>Type an asterisk character (*) if you would like to start a new paragraph.</ListItem>
      </List>
      #{paragraphs.map { |p| "<Text>#{p}</Text>" }}
    </QuestionContent>
    <AnswerSpecification>
      <FreeTextAnswer>
        <NumberOfLinesSuggestion>2></NumberOfLinesSuggestion>
        <Constraints>
          <Length minLength="3" />
          <AnswerFormatRegex regex="\S" errorText="The content cannot be blank."/>
        </Constraints>
      </FreeTextAnswer>
    </AnswerSpecification>
    <AnswerSpecification>%s</AnswerSpecification>
  </Question>
  QUESTION
  components << [TAIL]
  question = components.join

  result = mturk.createHIT(:Title => "Write one sentence in a short fiction story",
                    :Description => "Use your imagination to contribute one complete sentence to a short fictional story written by Mechanical Turk authors, one line at a time.",
                    :MaxAssignments => 1,
                    :Reward => { :Amount => 0.15, :CurrencyCode => 'USD' },
                    :Question => question,
                    :Keywords => "writing, content, creation, fiction, fun" )

  puts "Created HIT: #{result[:HITId]}"
  puts "Url: #{getHITUrl(result[:HITTypeId])}"
end

def getHITUrl(hitTypeId)
  if mturk.host =~ /sandbox/
    "http://workersandbox.mturk.com/mturk/preview?groupId=#{hitTypeId}" # Sandbox Url
  else
    "http://mturk.com/mturk/preview?groupId=#{hitTypeId}" # Production Url
  end
end

# Check to see if your account has sufficient funds
def hasEnoughFunds?
  available = mturk.availableFunds
  puts "Got account balance: %.2f" % available
  return available > 0.055
end

# These sentences were generated by a previous mechanical turk job
OPENING_SENTENCES = <<-OS
Jim approached the open door cautiously, unsure of the source of noise he had heard just moments prior.
It was midnight, she was driving back home after a long day at work still thinking of the stranger that had spoken to her in the street.
Yesterday was the best day of my whole life.
Today would be the third day Sarah and her younger brother had been on the road alone after running away from the orphanage.
Once upon a time, lived a little elf named snowball, who worked for Santa at the North Pole.
Hurriedly, she pushed the email icon on her phone to read the message from Sandy, the drug counselor.
There was something off about the way he watched her, his eyes never broke away - even after she had crossed the street.
"Well, everything went better than expected", Andy thought as he left the building with the business card still in his hand.
A lump rose in Andy's throat and he brushed away tears as he reread the chilling message taped to his dorm room door.
There was a funny little house in the town, that had stood vacant for many years.
It was a dark rainy night in November as Marcus felt a cold wind blow down Hanging Dog Creek.
It was the height of summer, it was warm and sunny and beautiful outside but Cooper didn't feel in any way excited as he sat at his kitchen table, sipping his by now luke warm morning coffee, trying to make sense of what had happened the night before.
I was a big, fast, tailback with a nasty streak and a taste for blood.
The old woman turned and smiled.
OS

story = OPENING_SENTENCES[8]

if hasEnoughFunds?
  30.times do |num|
    create_question(num,story)

  end
else
  puts "not enough funds"
end
