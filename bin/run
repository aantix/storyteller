#!/usr/bin/env ruby
# adapted from ruby-aws sample code

require "pp"
require_relative "../lib/init"
require 'amazon/webservices/mturk/question_generator'
include Amazon::WebServices::MTurk

PREAMBLE = '<?xml version="1.0" encoding="UTF-8"?>'+"\n"+'<QuestionForm xmlns="http://mechanicalturk.amazonaws.com/AWSMechanicalTurkDataSchemas/2005-10-01/QuestionForm.xsd">' + "\n"
TAIL = '</QuestionForm>'

def create_question(sentence_num,story)
  paragraphs = story.split(/\n/)

  components = [PREAMBLE]
  #components << <<-QUESTION
  #<Question>
    #<QuestionIdentifier>StorySentence#{sentence_num}</QuestionIdentifier>
    #<IsRequired>true</IsRequired>
    #<QuestionContent>
      #<Title>Add one complete sentence to the following story:</Title>
      #<List>
        #<ListItem>You must write a complete sentence that makes logical sense in the context of the story.</ListItem>
        #<ListItem>Write the first sentence that comes to mind.</ListItem>
        #<ListItem>Do not copy the sentence from another source.</ListItem>
        #<ListItem>Type an asterisk character (*) if you would like to start a new paragraph.</ListItem>
      #</List>
      #{paragraphs.map { |p| "<Text>#{p}</Text>" }.join("\n") }
    #</QuestionContent>
    #<AnswerSpecification>
      #<FreeTextAnswer>
        #<NumberOfLinesSuggestion>2></NumberOfLinesSuggestion>
        #<Constraints>
          #<Length minLength="3" />
          #<AnswerFormatRegex regex="\S" errorText="The content cannot be blank."/>
        #</Constraints>
      #</FreeTextAnswer>
    #</AnswerSpecification>
  #</Question>
  #QUESTION

  components << <<-QUESTION
  <Question>
    <QuestionIdentifier>StorySentence#{sentence_num}</QuestionIdentifier>
    <IsRequired>true</IsRequired>
    <QuestionContent>
      <Title>Add one complete sentence to the following story:</Title>
      <List>
        <ListItem>You must write a complete sentence that makes logical sense in the context of the story.</ListItem>
        <ListItem>Write the first sentence that comes to mind.</ListItem>
        <ListItem>Do not copy the sentence from another source.</ListItem>
        <ListItem>Type an asterisk character (*) if you would like to start a new paragraph.</ListItem>
      </List>
      #{paragraphs.map { |p| "<Text>#{p}</Text>" }.join("\n") }
    </QuestionContent>
    <AnswerSpecification>
      <FreeTextAnswer>
        <NumberOfLinesSuggestion>2</NumberOfLinesSuggestion>
      </FreeTextAnswer>
    </AnswerSpecification>
  </Question>
  QUESTION

  components << TAIL
  components.join
end

# Check to see if your account has sufficient funds
def hasEnoughFunds?
  available = mturk.availableFunds
  puts "Got account balance: %.2f" % available
  return available > 0.055
end

# These sentences were generated by a previous mechanical turk job
OPENING_SENTENCES = [
   "Jim approached the open door cautiously, unsure of the source of noise he had heard just moments prior.",
   "It was midnight, she was driving back home after a long day at work still thinking of the stranger that had spoken to her in the street.",
   "Yesterday was the best day of my whole life.",
   "Today would be the third day Sarah and her younger brother had been on the road alone after running away from the orphanage.",
   "Once upon a time, lived a little elf named snowball, who worked for Santa at the North Pole.",
   "Hurriedly, she pushed the email icon on her phone to read the message from Sandy, the drug counselor.",
   "There was something off about the way he watched her, his eyes never broke away - even after she had crossed the street.",
   "\"Well, everything went better than expected\", Andy thought as he left the building with the business card still in his hand.",
   "A lump rose in Andy's throat and he brushed away tears as he reread the chilling message taped to his dorm room door.",
   "There was a funny little house in the town, that had stood vacant for many years.",
   "It was a dark rainy night in November as Marcus felt a cold wind blow down Hanging Dog Creek.",
   "It was the height of summer, it was warm and sunny and beautiful outside but Cooper didn't feel in any way excited as he sat at his kitchen table, sipping his by now luke warm morning coffee, trying to make sense of what had happened the night before.",
   "I was a big, fast, tailback with a nasty streak and a taste for blood.",
   "The old woman turned and smiled."
]

# these are the sentences that were added by mechanical turk workers while
# testing this script.

story = [
  "A lump rose in Andy's throat and he brushed away tears as he reread the chilling message taped to his dorm room door.",
  "This can't be happening he thought, How could someone do this to me? Andy carefully took the note off of the door, and entered his room."
].join(" ")

options = {
  AWSAccessKeyId: ENV['AWS_ACCESS_KEY_ID'],
  AWSAccessKey: ENV['AWS_ACCESS_KEY'],
  Host: "Prod"
}

mturk = Amazon::WebServices::MechanicalTurkRequester.new(options)

1.times do |num|
  question = create_question(num,story)
  puts question

  begin
    result = mturk.createHIT(:Title => "Write one sentence in a short fiction story",
                             :Description => "Use your imagination to contribute one complete sentence to a short fictional story written by Mechanical Turk authors, one line at a time.",
                             :MaxAssignments => 1,
                             :Reward => { :Amount => 0.15, :CurrencyCode => 'USD' },
                             :Question => question,
                             :Keywords => "writing, content, creation, fiction, fun")
  rescue StandardError => e
    pp e
    exit
  end

  hit_id = result[:HITId]

  puts "Created HIT: #{hit_id}"

  if mturk.host =~ /sandbox/
    puts "http://workersandbox.mturk.com/mturk/preview?groupId=#{result[:HITTypeId]}"
  else
    puts "http://mturk.com/mturk/preview?groupId=#{result[:HITTypeId]}"
  end

  loop do
    result = mturk.getHITResults([{ HITId: hit_id }])
    if result.any?
      answer = result.first[:Answer]
      doc = Nokogiri::XML.parse(answer)
      sentence = doc.at_css("FreeText").text
      sentence.gsub!(/\*/,"\n")
      story << sentence
      puts "Received result: #{sentence}"
      break
    else
      puts "No result yet..."
      sleep(30)
    end
  end
end


#[{:Request=>{:IsValid=>"True"},
  #:HITId=>"26XE4EGDHDM268HOYVQWDHEZ65RBLM",
  #:HITTypeId=>"29P6NG1FS3NYO6K4496ZZZL2XRIZLY",
  #:CreationTime=>2011-12-02 21:59:10 UTC,
  #:Title=>"Write one sentence in a short fiction story",
  #:Description=>
   #"Use your imagination to contribute one complete sentence to a short fictional story written by Mechanical Turk authors, one line at a time.",
  #:Question=>
   #"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<QuestionForm xmlns=\"http://mechanicalturk.amazonaws.com/AWSMechanicalTurkDataSchemas/2005-10-01/QuestionForm.xsd\">\n  <Question>\n    <QuestionIdentifier>StorySentence0</QuestionIdentifier>\n    <IsRequired>true</IsRequired>\n    <QuestionContent>\n      <Title>Add one complete sentence to the following story:</Title>\n      <List>\n        <ListItem>You must write a complete sentence that makes logical sense in the context of the story.</ListItem>\n        <ListItem>Write the first sentence that comes to mind.</ListItem>\n        <ListItem>Do not copy the sentence from another source.</ListItem>\n        <ListItem>Type an asterisk character (*) if you would like to start a new paragraph.</ListItem>\n      </List>\n      <Text>A lump rose in Andy's throat and he brushed away tears as he reread the chilling message taped to his dorm room door.</Text>\n    </QuestionContent>\n    <AnswerSpecification>\n      <FreeTextAnswer>\n        <NumberOfLinesSuggestion>2</NumberOfLinesSuggestion>\n      </FreeTextAnswer>\n    </AnswerSpecification>\n  </Question>\n</QuestionForm>",
  #:Keywords=>"writing, content, creation, fiction, fun",
  #:HITStatus=>"Reviewable",
  #:MaxAssignments=>1,
  #:Reward=>{:Amount=>0.15, :CurrencyCode=>"USD", :FormattedPrice=>"$0.15"},
  #:AutoApprovalDelayInSeconds=>604800,
  #:Expiration=>2011-12-03 21:59:10 UTC,
  #:AssignmentDurationInSeconds=>3600,
  #:NumberOfSimilarHITs=>0,
  #:HITReviewStatus=>"NotReviewed",
  #:NumberOfAssignmentsPending=>0,
  #:NumberOfAssignmentsAvailable=>0,
  #:NumberOfAssignmentsCompleted=>0,
  #:AssignmentId=>"2OKCWY2AOO2GN9NMDW7QZCM6I9A33S",
  #:WorkerId=>"A25L94D9I3GJFQ",
  #:AssignmentStatus=>"Submitted",
  #:Answer=>
   #"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<QuestionFormAnswers xmlns=\"http://mechanicalturk.amazonaws.com/AWSMechanicalTurkDataSchemas/2005-10-01/QuestionFormAnswers.xsd\">\n<Answer>\n<QuestionIdentifier>StorySentence0</QuestionIdentifier>\n<FreeText>This can't be happening he thought, How could someone do this to me? Andy carefully took the note off of the door, and entered his room.</FreeText>\n</Answer>\n</QuestionFormAnswers>\n"}]

   #hit_id = "26XE4EGDHDM268HOYVQWDHEZ65RBLM"
